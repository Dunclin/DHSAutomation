<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Join Zoom - PLC Automation Hub</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { background: #000; color: #fff; }
    #zmmtg-root { height: 100vh; }
  </style>

  <!-- Zoom Web Meeting SDK (CDN) -->
  <script src="https://source.zoom.us/2.18.2/lib/vendor/react.min.js"></script>
  <script src="https://source.zoom.us/2.18.2/lib/vendor/react-dom.min.js"></script>
  <script src="https://source.zoom.us/2.18.2/lib/vendor/redux.min.js"></script>
  <script src="https://source.zoom.us/2.18.2/lib/vendor/redux-thunk.min.js"></script>
  <script src="https://source.zoom.us/2.18.2/lib/vendor/lodash.min.js"></script>
  <script src="https://source.zoom.us/zoom-meeting-2.18.2.min.js"></script>

  <script src="config.js"></script>
</head>
<body>
  <div id="zmmtg-root"></div>
  <script>
    function qp(name) {
      return new URL(window.location.href).searchParams.get(name);
    }

    const meetingNumber = qp('mn');
    const passcode = qp('pwd') || '';
    const userName = decodeURIComponent(qp('name') || 'PLC Guest');
    const userEmail = ''; // optional
    const role = 0; // attendee
    const sdkKey = window.ZOOM_SDK_KEY;
    const signatureEndpoint = window.ZOOM_SIGNATURE_ENDPOINT;

    if (!window.ZOOM_SDK_ENABLED) { alert('Zoom SDK is disabled. Enable it in config.js.'); }
    if (!meetingNumber || !sdkKey || !signatureEndpoint) {
      alert('Missing meetingNumber, SDK key, or signature endpoint. Check config.js and the URL.');
    }

    ZoomMtg.setZoomJSLib('https://source.zoom.us/2.18.2/lib', '/av');
    ZoomMtg.preLoadWasm();
    ZoomMtg.prepareJssdk();

    async function getSignature() {
      const res = await fetch(signatureEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ meetingNumber, role })
      });
      const data = await res.json().catch(() => ({}));
      return data.signature;
    }

    async function initAndJoin() {
      try {
        const signature = await getSignature();
        if (!signature) throw new Error('No signature returned');

        ZoomMtg.init({
          leaveUrl: window.location.origin,
          success: () => {
            ZoomMtg.join({
              signature,
              sdkKey,
              meetingNumber,
              userName,
              userEmail,
              passcode,
              success: () => { console.log('Zoom joined'); },
              error: (err) => { console.error(err); alert('Zoom join failed. See console.'); }
            });
          },
          error: (err) => { console.error(err); alert('Zoom init failed. See console.'); }
        });
      } catch (e) {
        console.error(e);
        alert('Could not start Zoom. Check console.');
      }
    }

    initAndJoin();
  </script>
</body>
</html>
